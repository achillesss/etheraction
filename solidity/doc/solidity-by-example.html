<!DOCTYPE html><html class="no-js"><head lang="zh-cn"><meta charset="utf-8"><meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=10"><title>Solidity 示例 - 精通以太坊</title><meta name="generator" content="Hugo 0.31.1"><meta name="description" content="从零成长为以太坊高级开发者"><link rel="canonical" href="https://ether.goall.top/solidity/doc/solidity-by-example.html"><meta name="author" content="虞双齐"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="renderer" content="webkit"><meta name="applicable-device" content="pc,mobile"><meta name="MobileOptimized" content="width"><meta name="HandheldFriendly" content="true"><meta name="mobile-web-app-capable" content="yes"><link rel="icon" sizes="32x32" href="https://ether.goall.top/images/favicon.ico"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="apple-mobile-web-app-title" content="精通以太坊"><link rel="apple-touch-icon-precomposed" href="https://ether.goall.top/images/app-icon64x64.png"><meta name="msapplication-TileImage" content="/images/app-icon128x128.png"><meta name="msapplication-TileColor" content="#0e90d2"><meta property="og:url" content="https://ether.goall.top/solidity/doc/solidity-by-example.html"><meta property="og:title" content="精通以太坊"><meta property="og:image" content="https://ether.goall.top/images/logo.png"><meta name="apple-mobile-web-app-title" content="精通以太坊"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"><link rel="shortcut icon" type="image/x-icon" href="https://ether.goall.top/images/favicon.ico"><link rel="icon" type="image/x-icon" href="https://ether.goall.top/images/favicon.ico"><style>@font-face{font-family:Icon;src:url(https://ether.goall.top/fonts/icon.eot);src:url(https://ether.goall.top/fonts/icon.eot) format('embedded-opentype'),url(https://ether.goall.top/fonts/icon.woff) format('woff'),url(https://ether.goall.top/fonts/icon.ttf) format('truetype'),url(https://ether.goall.top/fonts/icon.svg) format('svg');font-weight:400;font-style:normal}</style><link rel="stylesheet" href="https://ether.goall.top/stylesheets/application.css"><link rel="stylesheet" href="https://ether.goall.top/stylesheets/temporary.css"><link rel="stylesheet" href="https://ether.goall.top/stylesheets/palettes.css"><link rel="stylesheet" href="https://ether.goall.top/stylesheets/highlight/highlight.css"><link rel="stylesheet" href="//fonts.cat.net/css?family=Noto%20Sans%20CJK:400,700|Ubuntu&#43;Mono"><style>body,input{font-family:'Noto Sans CJK',Helvetica,Arial,sans-serif}code,pre{font-family:'Ubuntu Mono','Courier New',Courier,monospace}</style><script src="https://ether.goall.top/javascripts/modernizr.js"></script></head><body class="palette-primary-green palette-accent-teal"><div class="backdrop"><div class="backdrop-paper"></div></div><input class="toggle" type="checkbox" id="toggle-drawer"> <input class="toggle" type="checkbox" id="toggle-search"><label class="toggle-button overlay" for="toggle-drawer"></label><header class="header"><nav aria-label="Header"><div class="bar default"><div class="button button-menu" role="button" aria-label="Menu"><label class="toggle-button icon icon-menu" for="toggle-drawer"><span></span></label></div><div class="stretch"><div class="title">Solidity 示例</div></div><div class="button button-github" role="button" aria-label="GitHub"><a href="https://github.com/ysqi" title="@ysqi on GitHub" target="_blank" class="toggle-button icon icon-github"></a></div></div><div class="bar search"><div class="button button-close" role="button" aria-label="Close"><label class="toggle-button icon icon-back" for="toggle-search"></label></div><div class="stretch"><div class="field"><input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck></div></div><div class="button button-reset" role="button" aria-label="Search"><button class="toggle-button icon icon-close" id="reset-search"></button></div></div></nav></header><main class="main"><div class="drawer"><nav aria-label="Navigation"><a href="https://github.com/ysqi/etheraction" class="project"><div class="banner"><div class="logo"><img src="https://ether.goall.top/images/logo.png"></div><div class="name"><strong>精通以太坊 <span class="version">1.0.0</span></strong><br>ysqi/etheraction</div></div></a><div class="scrollable"><div class="wrapper"><ul class="repo"><li class="repo-download"><a href="https://github.com/ysqi/etheraction/archive/master.zip" target="_blank" title="Download" data-action="download"><i class="icon icon-download"></i> Download</a></li><li class="repo-stars"><a href="https://github.com/ysqi/etheraction/stargazers" target="_blank" title="Stargazers" data-action="star"><i class="icon icon-star"></i> Stars <span class="count">&ndash;</span></a></li></ul><hr><div class="toc"><ul><li><a title="前言" href="https://ether.goall.top/">前言</a></li><li><a title="第一章 基础知识" href="https://ether.goall.top/basic/">第一章 基础知识</a></li><li><a title="第二章 智能合约" href="https://ether.goall.top/contract/">第二章 智能合约</a></li><li><span class="section">第三章 Solidify 官方文档中译版</span><ul><a title="简介" href="https://ether.goall.top/solidity/doc/">简介 </a><a title="智能合约介绍" href="https://ether.goall.top/solidity/doc/introduction-to-smart-contracts.html">智能合约介绍 </a><a title="安装 Solidity" href="https://ether.goall.top/solidity/doc/installing-solidity.html">安装 Solidity </a><a class="current" title="Solidity 示例" href="https://ether.goall.top/solidity/doc/solidity-by-example.html">Solidity 示例</a><ul id="scrollspy"></ul><a title="深入了解 Solidity" href="https://ether.goall.top/solidity/doc/depth/">深入了解 Solidity</a><ul><a title="源文件布局" href="https://ether.goall.top/solidity/doc/depth/layout-of-source-files.html">源文件布局</a></ul></ul></li><li><a title="第四章 实战" href="https://ether.goall.top/action">第四章 实战</a></li><li><a title="license" href="https://ether.goall.top/license">license</a></li></ul><hr><span class="section">The author</span><ul><li><a href="https://github.com/ysqi" target="_blank" title="@ysqi on GitHub">@ysqi on GitHub</a></li><li><a href="mailto:devysq@gmail.com" title="Email of devysq@gmail.com">Contact via email</a></li></ul></div></div></div></nav></div><article class="article"><div class="wrapper"><h1>Solidity 示例</h1><h2 id="投票">投票</h2><p>下面合约十分复杂，但也展示了 Solidity 的许多特性。它实现的是一个投票合约。当然，电子投票的主要问题是如何确保合法投票人权利和避免暗箱操作。这里，我们先不需处理这些问题，先至少能看到如何委托投票，能<strong>自动记票</strong>，同时还是<strong>完全透明</strong>的。</p><p>想法是为每次选票创建一个合约，提供投票项简称。合约创建者充当主席，给每个地址分配投票权。地址背后的人类，就可以自行投票或者将投票权委托给他信任的第三方。在投票截止时，<code>winningProposal</code>方法返回投票数最多的提案。</p><pre><code class="language-js">pragma solidity ^0.4.16;

/// @title 代表团投票
contract Ballot {
    // 定义一个新的复合类型，会作为合约变量。
    // 代表一名选民。
    struct Voter {
        uint weight; // 累计的投票权重
        bool voted;  // 为 true 说明选名已投票
        address delegate; // 选民委托给第三方
        uint vote;   // 投票提案项
    }

    // 投票单个提案项
    struct Proposal {
        bytes32 name;   // 简称(32字节)
        uint voteCount; // 获票累计数
    }

    address public chairperson;

    // 声明了一个状态变量来存储每个地址所代表的 `Voter` 信息。 
    mapping(address =&gt; Voter) public voters;

    // 声明一个 `Proposal` 动态数组.
    Proposal[] public proposals;

    /// 创建一组新的提案进行投票 
    function Ballot(bytes32[] proposalNames) public {
        chairperson = msg.sender;
        voters[chairperson].weight = 1;

        // 遍历每份提案，为其创建一个新的 proposal 对象添加到投票提案组末尾
        for (uint i = 0; i &lt; proposalNames.length; i++) {
            // `Proposal({...})` 创建临时 Proposal 对象
            // `proposals.push(...)` 追加到 proposals 末尾。 
            proposals.push(Proposal({
                name: proposalNames[i],
                voteCount: 0
            }));
        }
    }

    // 给选民分配投票权，只有主席才可操作。
    function giveRightToVote(address voter) public {
        // 如果 `require` 参数计算结果为 `false`，将会终止并回复所有状态和余额变更。
        // 如果方法调用错误，这经常是一个好的处理方式。
        // 但需要小心，这也将消耗 gas (计划在未来调整)。
        require((msg.sender == chairperson) &amp;&amp; !voters[voter].voted &amp;&amp; (voters[voter].weight == 0));
        voters[voter].weight = 1;
    }

    /// 委托投票权给`to`
    function delegate(address to) public {
        // 获取引用
        Voter storage sender = voters[msg.sender];
        require(!sender.voted);

        // 不允许委托给自己
        require(to != msg.sender);

        // 当 `to` 也委托也委托时：
        // 一般来说，这样遍历是危险的，有可能需要执行很久，所需的 gas 超过区块所能提供的。使得委托不能被执行。
        // 另一种情况是，也许会导致合约执行完全卡住。
        while (voters[to].delegate != address(0)) {
            to = voters[to].delegate;

            // 不允许循环委托
            require(to != msg.sender);
        }

        // 标记为已投票
        sender.voted = true;
        sender.delegate = to;
        Voter storage delegate = voters[to];
        if (delegate.voted) {
            // 如果受托人已投票，则直接累加他的投票权重
            proposals[delegate.vote].voteCount += sender.weight;
        } else { 
            //  如果还没有，则转移受托人的投票权重
            delegate.weight += sender.weight;
        }
    }

    // 给指定提案投票（包括你是受托人）
    function vote(uint proposal) public {
        Voter storage sender = voters[msg.sender];
        require(!sender.voted);
        sender.voted = true;
        sender.vote = proposal;

        // 如果提案不在可选范围（超出索引），将自动抛错，并恢复变更
        proposals[proposal].voteCount += sender.weight;
    }

    /// @dev 计算胜出的提案，并返回所得票数
    function winningProposal() public view
            returns (uint winningProposal)
    {
        uint winningVoteCount = 0;
        for (uint p = 0; p &lt; proposals.length; p++) {
            if (proposals[p].voteCount &gt; winningVoteCount) {
                winningVoteCount = proposals[p].voteCount;
                winningProposal = p;
            }
        }
    }

    // 执行 winningProposal() 方法，获得胜出提案索引后，返回该提案简称。
    function winnerName() public view
            returns (bytes32 winnerName)
    {
        winnerName = proposals[winningProposal()].name;
    }
}
</code></pre><h3 id="可改进项">可改进项</h3><p>当前，需要进行N多次交易才能将投票权分配给所有参与者。你能想出更好的办法吗？</p><h2 id="秘密拍卖">秘密拍卖</h2><h2 id="公开拍卖">公开拍卖</h2><h2 id="安全远程买卖">安全远程买卖</h2><h2 id="小额支付">小额支付</h2><aside class="copyright" role="note">&copy; 2018 根据Apache 2.0 许可发布 &ndash; 文档基于 <a href="https://www.gohugo.io" target="_blank">Hugo</a>， 使用 <a href="https://github.com/ysqi/hugo-material-docs.git" target="_blank">Material</a> 主题构建.</aside><footer class="footer"><nav class="pagination" aria-label="Footer"><div class="previous"><a href="https://ether.goall.top/solidity/doc/installing-solidity.html" title="安装 Solidity"><span class="direction">Previous</span><div class="page"><div class="button button-previous" role="button" aria-label="Previous"><i class="icon icon-back"></i></div><div class="stretch"><div class="title">安装 Solidity</div></div></div></a></div><div class="next"><a href="https://ether.goall.top/solidity/doc/depth/" title="深入了解 Solidity"><span class="direction">Next</span><div class="page"><div class="stretch"><div class="title">深入了解 Solidity</div></div><div class="button button-next" role="button" aria-label="Next"><i class="icon icon-forward"></i></div></div></a></div></nav></footer></div></article><div class="results" role="status" aria-live="polite"><div class="scrollable"><div class="wrapper"><div class="meta"></div><div class="list"></div></div></div></div></main><script>var base_url = 'https:\/\/ether.goall.top';
      var repo_id  = 'ysqi\/etheraction';</script><script src="https://ether.goall.top/javascripts/application.js"></script><script>/* Add headers to scrollspy */
      var headers   = document.getElementsByTagName("h2");
      var scrollspy = document.getElementById('scrollspy');

      if(scrollspy) {
        if(headers.length > 0) {
          for(var i = 0; i < headers.length; i++) {
            var li = document.createElement("li");
            li.setAttribute("class", "anchor");

            var a  = document.createElement("a");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", headers[i].innerHTML);
            a.innerHTML = headers[i].innerHTML;

            li.appendChild(a)
            scrollspy.appendChild(li);
          }
        } else {
          scrollspy.parentElement.removeChild(scrollspy)
        }


        /* Add permanent link next to the headers */
        var headers = document.querySelectorAll("h1, h2, h3, h4, h5, h6");

        for(var i = 0; i < headers.length; i++) {
            var a = document.createElement("a");
            a.setAttribute("class", "headerlink");
            a.setAttribute("href", "#" + headers[i].id);
            a.setAttribute("title", "Permanent link")
            a.innerHTML = "#";
            headers[i].appendChild(a);
        }
      }</script><script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.8.0/highlight.min.js"></script><script>hljs.initHighlightingOnLoad();</script></body></html>